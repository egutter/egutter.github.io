<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Parallel tests for JRuby</title>
  <link href="https://egutter.github.io/prueba-blog/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://egutter.github.io/prueba-blog/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://egutter.github.io/prueba-blog/images/default.png);}
  
  </style>
</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://egutter.github.io/prueba-blog"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">10 Pines Blog</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
        
        
        
          <a href="https://www.facebook.com/10Pines"><img src="https://egutter.github.io/prueba-blog/images/facebook-dreamstale25.png"></a>
        
        
        
        
          <a href="https://www.linkedin.com/in/10Pines"><img src="https://egutter.github.io/prueba-blog/images/linkedin-dreamstale45.png"></a>
        
          <a href="https://egutter.github.io/prueba-blog/index.xml"><img src="https://egutter.github.io/prueba-blog/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://egutter.github.io/prueba-blog//images/10pines-background.jpg">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>Parallel tests for JRuby</h4>
          <p>
          
            
              <a href="https://egutter.github.io/prueba-blog/categories/jruby/">jruby</a>
            
              <a href="https://egutter.github.io/prueba-blog/categories/rspec/">rspec</a>
            
              <a href="https://egutter.github.io/prueba-blog/categories/parallel/">parallel</a>
            
           
          </p>
          <p><p>Recently, we&rsquo;ve been porting one of our projects from Ruby 1.9.3 (MRI) to JRuby 1.7.3. There was a fair amount of work involved, mainly about Ruby gems and (in)compatibility with C extensions (which JRuby dropped support), but that will be left for another post. Here, I&rsquo;d like to discuss the recent addition of JRuby support to the <a href="https://github.com/grosser/parallel_tests">parallel_tests</a> gem.</p>

<p>Our tests take about 20 minutes to run (it&rsquo;s suite of ~3800 examples, which are currently undergoing refactoring to improve performance), but a lot of the machine&rsquo;s processing power is unused. So I thought we could start by actually running all the code we can, before starting to profile and tune it. Also, if the delays were caused by waiting events, it wouldn&rsquo;t help making the code run faster. This sounds good, but it didn&rsquo;t turn out to be that easy.</p>

<p>First of all, parallel_tests depends on the parallel gem (which coincidentally doesn&rsquo;t support JRuby). But fortunately, it was only for monitoring the rspec subprocesses, and I switched to using threads (that also works on MRI, something I didn&rsquo;t expect and the author <a href="https://github.com/grosser/parallel_tests/pull/209">discovered soon after</a>). Traditionally one could manage children processes by saving their PIDs, I/O file descriptors and use something like <a href="http://linux.die.net/man/2/select">select(2)</a> (blocks execution until some children has output to read from). But in this case, additional processes were used just to monitor their only child.</p>

<p>A simpler solution than using <em>select(2)</em> was to use threads. These run simultaneously in JRuby, so it&rsquo;s no surprise it worked. It&rsquo;s interesting to mention that the reason it works in MRI is blocking: while one thread waits for I/O (like reading output from the children), other threads can continue. So, for example, if you have a program that waits a lot (something that can easily be seen with <a href="http://linux.die.net/man/1/time">time(1)</a> if &ldquo;user&rdquo; plus &ldquo;sys&rdquo; are lower than &ldquo;real&rdquo;), it may run faster with threads even on MRI.</p>

<p>So creating processes was necessary, as we needed to launch more instances of rspec (this could be avoided if rspec supported threads or worker processes, but it doesn&rsquo;t). The second problem was related to JRuby&rsquo;s implementation of <code>Open3::popen3</code>; it doesn&rsquo;t pass the fourth argument to the provided block, and doesn&rsquo;t parse command-line options correctly. That also happens with <em>popen4</em> (a JRuby replacement for the open4 gem), and even if the normal &ldquo;open&rdquo; works with pipes, it doesn&rsquo;t capture stderr. So we ended up using <code>Open3::popen3</code> to spawn a shell, and pass the command through stdin (to avoid parsing issues). See the <a href="https://github.com/grosser/parallel_tests/pull/208">pull request</a>.</p>

<p>Finally, some tests failed because they had small delays to ensure correct ordering of operations, and the JVM delay was larger. So they were marked as pending for now. The performance gain wasn&rsquo;t much, partly because of another issue with rspec reporter (the class used by progress bars and formatters): shared examples are counted separately, instead of adding the time to the examples that used them (see <a href="https://github.com/grosser/parallel_tests/issues/164">#164</a> and <a href="https://github.com/grosser/parallel_tests/issues/212">#212</a>). But that&rsquo;s a story for the upcoming post&hellip;</p>
</p>
          <p>7 May 2013
            
          </p>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2013/05/18/parallel-tests-on-travis/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2012/06/11/10-pines-una-empresa-diferente/"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/materialize.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

