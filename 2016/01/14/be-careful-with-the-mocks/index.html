<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Be careful with the mocks</title>
  <link href="https://egutter.github.io/prueba-blog/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://egutter.github.io/prueba-blog/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://egutter.github.io/prueba-blog/images/default.png);}
  
  </style>
</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://egutter.github.io/prueba-blog"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">10 Pines Blog</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
        
        
        
          <a href="https://www.facebook.com/10Pines"><img src="https://egutter.github.io/prueba-blog/images/facebook-dreamstale25.png"></a>
        
        
        
        
          <a href="https://www.linkedin.com/in/10Pines"><img src="https://egutter.github.io/prueba-blog/images/linkedin-dreamstale45.png"></a>
        
          <a href="https://egutter.github.io/prueba-blog/index.xml"><img src="https://egutter.github.io/prueba-blog/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://egutter.github.io/prueba-blog//images/10pines-background.jpg">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>Be careful with the mocks</h4>
          <p>
          
            
              <a href="https://egutter.github.io/prueba-blog/categories/tests-mocks/">tests mocks</a>
            
           
          </p>
          <p><p>Mocking objects is a common practice when writing tests, however it can be painful when refactoring a class tested with mocks. I will show a simple example to explain the problems that mocking can generate, but first I would like to give some definitions:</p>

<ul>
<li><strong>Stubs</strong> are objects that respond to a subset of messages from the object to be stubbed with specific responses.</li>
<li><strong>Mocks</strong> are objects that verify the integration between the system under test and the mocked object.</li>
<li><strong>Fake</strong> are objects with implementation that simulate the real one but they are simpler and/or faster.</li>
</ul>

<p>Suppose we have the next class for sending email notifications to an user of our system:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">EmailNotifier</span> <span style="color: #f8f8f2">{</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">initialize</span><span style="color: #f8f8f2">(email_client,</span> <span style="color: #f8f8f2">from_email)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">@email_client</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">email_client</span>
        <span style="color: #f8f8f2">@from_email</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">from_email</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">notify</span><span style="color: #f8f8f2">(an_user,</span> <span style="color: #f8f8f2">a_message)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">@email_client</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">send(@from_email,</span> <span style="color: #f8f8f2">an_user</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">email,</span> <span style="color: #f8f8f2">a_message)</span>
    <span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">}</span>
</pre></div>


<p>There are some different ways to write the tests for the <code>notify</code> method. Maybe the easiest way of doing it is using mocks:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #f8f8f2">describe</span> <span style="color: #66d9ef">EmailNotification</span> <span style="color: #66d9ef">do</span>

    <span style="color: #f8f8f2">describe</span> <span style="color: #e6db74">:notify</span> <span style="color: #66d9ef">do</span>    

        <span style="color: #f8f8f2">it</span> <span style="color: #e6db74">&#39;sends an email to the given user with the given message&#39;</span> <span style="color: #66d9ef">do</span>

            <span style="color: #f8f8f2">from_email</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;server@test.com&quot;</span>
            <span style="color: #f8f8f2">user_email_address</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;user@test.com&quot;</span>
            <span style="color: #f8f8f2">user</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">double(</span><span style="color: #e6db74">&quot;User&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">email</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">user_email_address)</span>
            <span style="color: #f8f8f2">message</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;Message&quot;</span>

            <span style="color: #f8f8f2">email_client</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">double(</span><span style="color: #e6db74">&#39;EmailClient&#39;</span><span style="color: #f8f8f2">)</span>
            <span style="color: #f8f8f2">expect(email_client)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">to</span> <span style="color: #f8f8f2">receive(</span><span style="color: #e6db74">:send</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">with(from_email,</span> <span style="color: #f8f8f2">user_email_address,</span> <span style="color: #f8f8f2">message)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">and_return(</span><span style="color: #e6db74">:success</span><span style="color: #f8f8f2">)</span>

            <span style="color: #f8f8f2">notifier</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">EmailNotifier</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new</span> <span style="color: #f8f8f2">email_client,</span> <span style="color: #f8f8f2">from_email</span>
            <span style="color: #f8f8f2">notifier</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">notify(user,</span> <span style="color: #f8f8f2">message)</span>
        <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>On this test we have created one stub for User and a mock for EmailClient. In order to check if an email is sent, we defined the expectations knowing the implementation should call the send message, but by doing this we are writing tests that are strongly coupled to their method implementation because it is expecting <code>notify</code> to send the message <code>send</code> to <code>email_client</code>. So, in my opinion, testing a message in this way has the next problems:</p>

<ul>
<li><strong>It is testing HOW the method is implemented instead of WHAT the method should do</strong>, which may result on test failures if we change the code. Instead of testing the <code>send</code> message is called, we should be testing an email has been sent.</li>
<li><strong>It forces you to write the expected behavior of the mocked class in each test</strong>, which distracts you from the test itself when reading and writing the test, and also, it may increase the difficulty of understanding it.</li>
<li><strong>The tests are hard to maintain</strong>, changing a message of the mocked class will require to change all the places in which that message was mocked. If one of the tests that mocks this message is not changed, it may generate a <em>false positive</em>, for example, if you remove the message <code>send</code> from <em>EmailClient</em>, the mock wouldn&rsquo;t fail, so the test will pass.</li>
</ul>

<p>One option to solve the first 2 problems and reduce the impact of the last one can be to use a <em>Fake object</em>. In this case, we should write a <em>FakeEmailClient</em>, which should respond to the same messages of the real <em>EmailNotifier</em>, and also it should have a message to test the sender, the receiver, the message and if an email has been sent. Creating a <em>FakeEmailClient</em> won&rsquo;t solve the <em>false positive</em> problem, but it will be easier to fix because you should only update the fake object instead of all the tests where the <em>EmailClient</em> is used.</p>

<p>Let&rsquo;s assume the <em>EmailClient</em> class has a constructor without parameters, and it only has the <code>send(from, to, message)</code> method. In that case, the <em>Fake Class</em> would be:</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">FakeEmailClient</span> <span style="color: #f8f8f2">{</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">send</span><span style="color: #f8f8f2">(sender_address,</span> <span style="color: #f8f8f2">to_address,</span> <span style="color: #f8f8f2">message)</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">@last_sender_address</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">from_address</span>
        <span style="color: #f8f8f2">@last_receiver_address</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">to_address</span>
        <span style="color: #f8f8f2">@last_message_sent</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">message</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #66d9ef">attr_reader</span> <span style="color: #e6db74">:last_sender_address</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">:last_receiver_address</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">:last_message_sent</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">assert_last_email_received</span><span style="color: #f8f8f2">(from,</span> <span style="color: #f8f8f2">to,</span> <span style="color: #f8f8f2">message)</span>
        <span style="color: #f8f8f2">expect(@last_sender_address)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">to</span> <span style="color: #f8f8f2">eq(from_address)</span>
        <span style="color: #f8f8f2">expect(@last_receiver_address)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">to</span> <span style="color: #f8f8f2">eq(to_address)</span>
        <span style="color: #f8f8f2">expect(@last_message_sent)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">to</span> <span style="color: #f8f8f2">eq(message)</span>
    <span style="color: #66d9ef">end</span>
</pre></div>
</p>

<p>This <em>Fake object</em> should be used in every test that needs to use an <em>EmailClient</em>, and if you need to test if an email has been sent, you can ask it to the fake client.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #f8f8f2">describe</span> <span style="color: #66d9ef">EmailNotification</span> <span style="color: #66d9ef">do</span>

    <span style="color: #f8f8f2">describe</span> <span style="color: #e6db74">:notify</span> <span style="color: #66d9ef">do</span>    

        <span style="color: #f8f8f2">it</span> <span style="color: #e6db74">&#39;sends an email to the given user with the given message&#39;</span> <span style="color: #66d9ef">do</span>

            <span style="color: #f8f8f2">from_email</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;server@test.com&quot;</span>
            <span style="color: #f8f8f2">user_email_address</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;user@test.com&quot;</span>
            <span style="color: #f8f8f2">user</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">double(</span><span style="color: #e6db74">&quot;User&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">email</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">user_email_address)</span>
            <span style="color: #f8f8f2">message</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;Message&quot;</span>

            <span style="color: #f8f8f2">email_client</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">FakeEmailClient</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new</span>

            <span style="color: #f8f8f2">notifier</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">EmailNotifier</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new</span> <span style="color: #f8f8f2">email_client,</span> <span style="color: #f8f8f2">from_email</span>
            <span style="color: #f8f8f2">notifier</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">notify(user,</span> <span style="color: #f8f8f2">message)</span>

            <span style="color: #f8f8f2">email_client</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">assert_last_email_received(from_email,</span> <span style="color: #f8f8f2">user_email_address,message)</span>
        <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>To conclude, I am not saying that mocks are useless, but I think that avoiding them whenever is possible makes the tests safer and easier to understand and maintain.</p>
</p>
          <p>14 Jan 2016
            
          </p>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2016/02/11/to-care-or-not-to-care/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2016/01/04/there-are-null-reasons/"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/materialize.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

