
<!DOCTYPE html>
<html lang="en-us">

    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" Collection Filters in Ruby &middot;  10 Pines Blog" />
        <meta property="og:site_name" content="10 Pines Blog" />
        <meta property="og:url" content="http://egutter.github.io/prueba-blog/2016/07/14/collection-filters-in-ruby/" />

    
        <meta property="og:type" content="article" />
        <meta property="og:article:published_time" content="2016-07-14T13:00:00Z" />
        

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@" />
        <meta name="twitter:creator" content="@" />
        <meta name="twitter:title" content="Collection Filters in Ruby" />
        <meta name="twitter:description" content="" />
        <meta name="twitter:url" content="http://egutter.github.io/prueba-blog/2016/07/14/collection-filters-in-ruby/" />
    

        <title> Collection Filters in Ruby &middot;  10 Pines Blog</title>

    
        <meta name="description" content="" />
    

        <meta name="p:domain_verify" content="fc173d84e3a4de948ed4bda2908afd3e"/>
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        
        

    
        <link href="http://egutter.github.io/prueba-blog/index.xml" rel="alternate" type="application/rss+xml" title="10 Pines Blog" />
    

    
        <link rel="canonical" href="http://egutter.github.io/prueba-blog/2016/07/14/collection-filters-in-ruby/" />

    
    <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Collection Filters in Ruby",
        "author": {
            "@type": "Person",
            "name": "http://profiles.google.com/?rel=author"
        },
        "datePublished": "2016-07-14",
        "description": "",
        "wordCount":  1077 
    }

    </script>

    <script type="text/javascript">
    
    
      var disqus_shortname = '10pinesblog';
      var disqus_identifier = 'http:\/\/egutter.github.io\/prueba-blog\/2016\/07\/14\/collection-filters-in-ruby\/';
      var disqus_title = 'Collection Filters in Ruby';
      var disqus_url = 'http:\/\/egutter.github.io\/prueba-blog\/2016\/07\/14\/collection-filters-in-ruby\/';
    

    </script>
    

    <style>
@charset "UTF-8";article,header,img,main,nav,section{display:block}blockquote,p,pre,ul{margin:2em auto}#wrapper,pre{width:100%;box-sizing:border-box}#nav,#wrapper,code{position:relative}#nav,body{background:#fff}#menu,blockquote,pre code{background:0 0}#menu,#menu .menu-header,#menu .menu-list,#wrapper,.post-nav .post-nav-item .post-nav-teaser .post-nav-info,blockquote,pre{box-sizing:border-box}img{border:0;max-width:100%;height:auto;margin:2.5em auto}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}code,pre{font-family:monospace,monospace;font-size:1em}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:300;src:local("Merriweather Sans Light"),local("MerriweatherSans-Light"),url(//fonts.gstatic.com/s/merriweathersans/v5/6LmGj5dOJopQKEkt88GowY_zIojJi0m4a5Z6tRh6itY.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:400;src:local("Merriweather Sans Regular"),local("MerriweatherSans-Regular"),url(//fonts.gstatic.com/s/merriweathersans/v5/AKu1CjQ4qnV8MUltkAX3sL2aU247V0zTzydO4RoO9Ok.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:700;src:local("Merriweather Sans Bold"),local("MerriweatherSans-Bold"),url(//fonts.gstatic.com/s/merriweathersans/v5/6LmGj5dOJopQKEkt88GowQfd-b-I5PxxcmB4_-MNcqw.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:normal;font-weight:800;src:local("Merriweather Sans ExtraBold"),local("MerriweatherSans-ExtraBold"),url(//fonts.gstatic.com/s/merriweathersans/v5/6LmGj5dOJopQKEkt88GowWT7sFQ1Iz1BbpcuCPlgc9Q.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:italic;font-weight:300;src:local("Merriweather Sans Light Italic"),local("MerriweatherSans-LightItalic"),url(//fonts.gstatic.com/s/merriweathersans/v5/nAqt4hiqwq3tzCecpgPmVX9UU5BmOJGkLxUCVv5VXdc.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:italic;font-weight:400;src:local("Merriweather Sans Italic"),local("MerriweatherSans-Italic"),url(//fonts.gstatic.com/s/merriweathersans/v5/3Mz4hOHzs2npRMG3B1ascf0KIgDhPIHb_R-SWdtqte8.woff) format("woff")}@font-face{font-family:'Merriweather Sans';font-style:italic;font-weight:700;src:local("Merriweather Sans Bold Italic"),local("MerriweatherSans-BoldItalic"),url(//fonts.gstatic.com/s/merriweathersans/v5/nAqt4hiqwq3tzCecpgPmVYM8pfYvjMoOxygpzLVILAs.woff) format("woff")}@font-face{font-family:Inconsolata;font-style:normal;font-weight:400;src:local("Inconsolata"),url(//fonts.gstatic.com/s/inconsolata/v12/BjAYBlHtW3CJxDcjzrnZCIbN6UDyHWBl620a-IRfuBk.woff) format("woff")}@font-face{font-family:Inconsolata;font-style:normal;font-weight:700;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url(//fonts.gstatic.com/s/inconsolata/v12/AIed271kqQlcIRSOnQH0yTqR_3kx9_hJXbbyU8S6IN0.woff) format("woff")}@font-face{font-family:icons;src:url(/fonts/icons.eot?9273991);src:url(/fonts/icons.eot?9273991#iefix) format("embedded-opentype"),url(/fonts/icons.woff?9273991) format("woff"),url(/fonts/icons.ttf?9273991) format("truetype"),url(/fonts/icons.svg?9273991#icons) format("svg");font-weight:400;font-style:normal}[class^=icon-]:before{font-family:icons;font-style:normal;font-weight:400;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-arrow-left:before{content:'\e804'}.icon-arrow-right:before{content:'\e807'}.icon-rss:before{content:'\e808'}.icon-menu:before{content:'\e809'}body{margin:0;font:300 1em/1.5em 'Merriweather Sans',sans-serif;color:#595B66}blockquote,i{font-style:italic}code,pre{font-family:Inconsolata,monospace}a,blockquote,code,i{font-weight:400}::-moz-selection{color:#222;background:#D6EDFF;text-shadow:none}::-moz-selection,::selection{color:#222;background:#D6EDFF;text-shadow:none}a{background-color:transparent;color:inherit;text-decoration:none;transition:all ease-out .2s}.post-content a{border-bottom:2px solid #36D995}h1,h4{text-rendering:optimizeLegibility;color:#1F2026}h1{font-size:2em;line-height:1em;margin:2em 0 -.5em}h4{font-size:1.25em;line-height:1.2em;margin:2.4em 0 -.8em}ul{list-style:none;padding-left:3em}blockquote{padding:0 1em;border-left:.25em solid #D4D5D9;color:#595B66}blockquote *{margin:1em auto}blockquote :first-child{margin-top:0}blockquote :last-child{margin-bottom:0}i{color:#363740}code{display:inline-block;top:-1px;padding:3px 6px;margin:-1px 2px;font-size:.875em;line-height:1.143em;background:#E1E2E6;color:#000;border-radius:2px}pre{padding:1em;white-space:pre;overflow:auto;background:#9D9FA6;color:#fff}pre code{position:static;top:auto;font-size:1em;line-height:1.5em;white-space:-moz-pre-wrap;white-space:pre-wrap;vertical-align:inherit;border:none;padding:0}#menu .menu-header:before,.post .post-title:before{border-bottom:4px solid #36D995;content:''}.inner{max-width:48em;margin:0 auto;padding:0 1em}#wrapper{min-height:100vh;padding-bottom:6em;background:#F2F3F5}#push{-webkit-transform:translate3d(0,0,0);transform:translate3d(0,0,0);-webkit-transform-style:preserve-3d;transform-style:preserve-3d;opacity:1}#nav{z-index:70;transition:all ease-out .4s;-webkit-transform:translate3d(0,0,0);transform:translate3d(0,0,0);-webkit-transform-style:preserve-3d;transform-style:preserve-3d;opacity:1}#nav:after{clear:both;content:'';display:table}#nav .nav-logo{float:left;height:2em;padding:1em;max-width:50%}#nav .nav-logo img{width:auto;max-width:none;height:2em;margin:0}#nav .nav-menu{float:right}#nav .nav-menu:after{clear:both;content:'';display:table}#nav .nav-menu a{display:block;width:1em;height:1em;line-height:1em;padding:1.5em;text-align:center;float:left;cursor:pointer}#nav .nav-menu a i:before{margin:auto}#menu{display:none;position:fixed;left:50%;top:5%;width:30em;height:90%;margin-left:-15em;padding:3em 0 0;overflow:hidden;transition:all ease-out .3s;-webkit-transform:translate3d(0,2em,0);transform:translate3d(0,2em,0);-webkit-transform-style:preserve-3d;transform-style:preserve-3d;opacity:0;z-index:100}@media only screen and (max-width:50em){#menu{width:90%;left:5%;margin-left:auto}}#menu .menu-header{position:absolute;left:0;top:0;width:100%;height:3.5em;padding:1em 1.5em .5em;margin-bottom:1em;line-height:2em;z-index:110;background:#fff}#menu .menu-header:before{position:absolute;left:-5%;bottom:-1em;width:110%;height:2em;background:#fff;box-shadow:0 .125em .125em rgba(0,0,0,.1);-webkit-transform:rotate(2.5deg);transform:rotate(2.5deg);transition:all ease-out .2s;z-index:115}#menu .menu-header:after{clear:both;content:'';display:table}#menu .menu-header .menu-label{position:relative;display:block;float:left;z-index:120}#menu .menu-header .menu-close{position:relative;display:block;float:right;width:2em;height:2em;padding:1em;margin:-1em -1.5em -1em 0;cursor:pointer;z-index:125}#menu .menu-header .menu-close:after,#menu .menu-header .menu-close:before{content:'';position:absolute;left:50%;top:50%;background:#9D9FA6;-webkit-transform:rotate(45deg);transform:rotate(45deg)}.overlay,.overlay:before{top:0;width:100%;height:100%}#menu .menu-header .menu-close:after{width:2px;height:1em;margin:-.5em 0 0 -1px}#menu .menu-header .menu-close:before{width:1em;height:2px;margin:-1px 0 0 -.5em}#menu .menu-list{position:relative;list-style:none;margin:0;padding:2em 0;height:100%;overflow-x:hidden;overflow-y:scroll;background:#fff}.overlay{position:fixed;left:0;z-index:80;display:none}.overlay:before{content:'';position:absolute;left:0;background:#1F2026;opacity:0;transition:all ease-out .3s;-webkit-transform-style:preserve-3d;transform-style:preserve-3d}.post{position:relative;z-index:20}.post .post-meta{display:block;font-size:.75em;line-height:1.334em;font-weight:400;margin-bottom:1.334em}.post .post-title{position:relative;color:#000;font-size:2em;line-height:1.375em;font-weight:800;text-indent:-1px;margin:.25em 0 .75em}.post .post-title:before{position:absolute;left:0;bottom:-.334em;width:1em;margin-bottom:-2px}.post .post-header{padding:4em 0 0;margin-bottom:3em}.post-footer .post-share a span{display:none}.post-nav .post-nav-item{position:fixed;top:50%;display:block;margin-top:-4em;overflow:hidden;border-radius:10em;transition:none}@media only screen and (max-width:70em){.post-nav .post-nav-item{position:absolute;top:auto;margin:auto;max-width:50%}}.post-nav .post-nav-item.post-nav-next{left:0;text-align:left}.post-nav .post-nav-item.post-nav-next .post-nav-icon{float:left}.post-nav .post-nav-item.post-nav-next .post-nav-icon i{left:-.05em}.post-nav .post-nav-item.post-nav-next .post-nav-info{padding-left:6em}.post-nav .post-nav-item.post-nav-prev{right:0;text-align:right}.post-nav .post-nav-item.post-nav-prev .post-nav-icon{float:right}.post-nav .post-nav-item.post-nav-prev .post-nav-icon i{right:-.05em}.post-nav .post-nav-item.post-nav-prev .post-nav-info{padding-right:6em}.post-nav .post-nav-item .post-nav-teaser{display:block;padding:1em;transition:all ease-out .2s;max-width:25em;overflow:visible}.post-nav .post-nav-item .post-nav-teaser:after{clear:both;content:'';display:table}.post-nav .post-nav-item .post-nav-teaser .post-nav-icon{display:block;width:5em;height:5em;line-height:5em;text-align:center;box-sizing:border-box;border-radius:10em;border:1px solid #36D995;box-shadow:0 0 0 0 transparent;transition:all ease-out .1s;background:#F2F3F5}.post-nav .post-nav-item .post-nav-teaser .post-nav-icon i{position:relative;font-size:2em}@media only screen and (max-width:30em){.post-nav .post-nav-item .post-nav-teaser .post-nav-icon{width:4em;height:4em;line-height:4em}.post-nav .post-nav-item .post-nav-teaser .post-nav-icon i{font-size:1.5em}}.post-nav .post-nav-item .post-nav-teaser .post-nav-icon i:before{margin:auto}.post-nav .post-nav-item .post-nav-teaser .post-nav-info{display:none;width:100%;transition:all ease-out .2s}.post-nav .post-nav-item .post-nav-teaser .post-nav-info .post-nav-title{display:block;max-height:1.25em;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;margin:1.25em 0 .25em;font-size:1em;line-height:1.25em;font-weight:700;color:#363740}.post-nav .post-nav-item .post-nav-teaser .post-nav-info .post-nav-excerpt{display:block;max-height:1.334em;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;margin:0;font-size:.75em;line-height:1.334em;font-weight:400;color:#9D9FA6}
</style>


    </head>
    <body class="home-template" style="display: none;">
      <section id="wrapper">
        <div id="ajax-container">
          <nav id="nav" class="nav">
            <div class="nav-logo">
              <a href="http://egutter.github.io/prueba-blog/">
      			  	
      			  	
      			  	<img src="http://egutter.github.io/prueba-blog/images/10p-logo.png" alt="Logo"/>
      			  	
              </a>
			  	    
            </div>
            <div class="nav-menu">
              <a class="rss" href="">
                <i class="icon-rss"></i>
              </a>
                
                <a class="menu" data-action="toc" data-target="toc"><i class="icon-location"></i></a>
                
                
            </div>
          </nav>


<main class="content" role="main">
	<article class="post">
		<div class="inner">

			<div id="push">

  			<header class="post-header">
  				<span class="post-meta">
						<span class="post-date">14 Jul 2016</span> <span class="reading-time">| <span class="estimated-reading-time">6 min.</span> (<span class="word-count">1077</span> words)</span></span>
  				</span>
  				<div class="clear"></div>
  				<h1 class="post-title">Collection Filters in Ruby</h1>
  			</header>

  			<section class="post-content">
  				

<p><strong>Note:</strong> acknowledgements (and thanks!) to Máximo Prieto (our OOP guru) who had this idea and he implemented it on
Smalltalk.</p>

<h2 id="the-problem">The problem</h2>

<p>We want to have a collection that filters its elements as we add them using a given condition. For instance, we can
have an <code>Array</code> that only allows even numbers.</p>

<p>First, and important, is to understand what a filter <em>is</em>. &ldquo;filter&rdquo; is a very overloaded word, and sometimes used in a
technical way. Let&rsquo;s say that a filter is someone with the single responsibility of deciding if something has to pass
over or not.</p>

<h2 id="first-approach">First approach</h2>

<p>The first, and more intuitive approach, is to subclass <code>Array</code> and override <code>&lt;&lt;</code> and any other &ldquo;adding&rdquo; methods if
needed. Something like this:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">FilteredArray</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">Array</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">filter_with</span><span style="color: #f8f8f2">(condition)</span>
    <span style="color: #66d9ef">new</span><span style="color: #f8f8f2">(condition)</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">initialize</span><span style="color: #f8f8f2">(condition)</span>
    <span style="color: #f8f8f2">@condition</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">condition</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">&lt;&lt;</span><span style="color: #f8f8f2">(element)</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">@condition</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">call(element)</span>
      <span style="color: #66d9ef">super</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>Which problems does it have?</p>

<ul>
<li><p>It is specific to <code>Array</code>s. if we want to filter other kind of collections, we need to create specific subclasses for
each of them. We can move a step forward and try to define a <code>Filterable</code> module or something similar, but we will need
to touch collection classes anyway. So we will avoid mixins.</p></li>

<li><p>It uses an <code>if</code>. Remember, #RealDevsDontUseIf (it&rsquo;s in our T-shirts, we take this seriously). We are losing a
concept here if we limit the solution to just put an if, just because it <em>looks</em> simpler.</p></li>

<li><p>The filter is not reified. We just <em>hacked</em> something into <code>Array</code>. We still do not <em>know</em> what a filter <em>is</em>.</p></li>
</ul>

<h2 id="the-idea">The idea</h2>

<p>There should be a filter object, and it should be placed between the user and the filtered object. Imagine you are
modeling a person using a pair of glasses. Does the eyes tell the glass what/how to filter? No, glasses do!. So why
a collection need to decide whether to filter or not? is it in its essence?</p>

<p>Light goes first to the glasses, then glasses &ldquo;decide&rdquo; which light pass to the eyes. In a similar way, a &ldquo;collection
filter&rdquo; decide which objects passes and which don&rsquo;t.</p>

<h2 id="implementing-collection-filters">Implementing collection filters</h2>

<p>The two main responsibilities of a collection filter are:</p>

<ul>
<li>Intercept the &ldquo;adding&rdquo; messages, to evaluate the given condition and decide what to do based on the result.</li>
<li>Delegate any other messages to the collection.</li>
</ul>

<p>This collection filter should act as an &ldquo;invisible proxy&rdquo;, so the user does not know if they are using a filter or a
collection. It should be a polymorphic object respect to collections. To implement it, I subclassed my proxy object from
<code>BasicObject</code>. Maybe there is a better solution, but it solved my concrete problem here. It&rsquo;s not the purpose
of this post discussing proxy implementations.</p>

<p>Introducing the proxy object, and the definition of <code>&lt;&lt;</code>, we end up with this code:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">UndefinedCollectionFilter</span> <span style="color: #f92672">&lt;</span> <span style="color: #66d9ef">BasicObject</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">initialize</span><span style="color: #f8f8f2">(collection,</span> <span style="color: #f8f8f2">condition)</span>
    <span style="color: #f8f8f2">@collection</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">collection</span>
    <span style="color: #f8f8f2">@condition</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">condition</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">&lt;&lt;</span><span style="color: #f8f8f2">(an_object)</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">@condition</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">call(an_object)</span>
      <span style="color: #66d9ef">super</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">respond_to?</span><span style="color: #f8f8f2">(selector,</span> <span style="color: #f8f8f2">include_private</span><span style="color: #f92672">=</span><span style="color: #66d9ef">false</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">@collection</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">respond_to?(selector,</span> <span style="color: #f8f8f2">include_private)</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">private</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">method_missing</span><span style="color: #f8f8f2">(selector,</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">args,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">block)</span>
    <span style="color: #f8f8f2">@collection</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">send(selector,</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">args,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">block)</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>Are we done? Can we go home? No! we still have the <code>if</code>. How can we eliminate it? Well, we have 3 different filtering
decisions, so we should have 3 objects representing each one. Let me introduce you those objects:</p>

<ul>
<li><strong>Undefined filter</strong>: it is the &ldquo;passive&rdquo; filter, the object that is waiting for an object to come. As it does not
know if should behave as open or closed, we call it undefined. It&rsquo;s the object that we will pass to the user and it
will act as an invisible proxy.</li>
<li><strong>Open filter</strong>: it is the object that should let the object pass.</li>
<li><strong>Closed filter</strong>: in opposition to the open filter, this object should not let the object pass.</li>
</ul>

<p>After implementing the filters, and the logic to decide which filter to use in each case, the code resulted in:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e"># collection_filter/undefined.rb</span>
<span style="color: #66d9ef">module</span> <span style="color: #f8f8f2">CollectionFilter</span>
  <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Undefined</span> <span style="color: #f92672">&lt;</span> <span style="color: #66d9ef">BasicObject</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">filter_with</span><span style="color: #f8f8f2">(collection,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #66d9ef">new</span><span style="color: #f8f8f2">(collection,</span> <span style="color: #f8f8f2">block)</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">initialize</span><span style="color: #f8f8f2">(collection,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #f8f8f2">@collection</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">collection</span>
      <span style="color: #f8f8f2">@condition</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">block</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">&lt;&lt;</span><span style="color: #f8f8f2">(object)</span>
      <span style="color: #f8f8f2">filter_for(object)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">add(object,</span> <span style="color: #f8f8f2">@collection)</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">respond_to?</span><span style="color: #f8f8f2">(selector,</span> <span style="color: #f8f8f2">include_private</span><span style="color: #f92672">=</span><span style="color: #66d9ef">false</span><span style="color: #f8f8f2">)</span>
      <span style="color: #f8f8f2">@collection</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">respond_to?(selector,</span> <span style="color: #f8f8f2">include_private)</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">private</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">filter_for</span><span style="color: #f8f8f2">(object)</span>
      <span style="color: #f8f8f2">filters_provider</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find_filter(object,</span> <span style="color: #f8f8f2">@condition)</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">filters_provider</span>
      <span style="color: #66d9ef">Base</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">method_missing</span><span style="color: #f8f8f2">(selector,</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">args,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">block)</span>
      <span style="color: #f8f8f2">@collection</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">send(selector,</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">args,</span> <span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">block)</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>

<span style="color: #75715e"># collection_filter/base.rb</span>
<span style="color: #f8f8f2">require</span> <span style="color: #e6db74">&#39;error_handling_protocol&#39;</span>

<span style="color: #66d9ef">module</span> <span style="color: #f8f8f2">CollectionFilter</span>
  <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Base</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">find_filter</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #f8f8f2">filter_implementation_for(object,</span> <span style="color: #f8f8f2">block)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">filter_implementation_for</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #f8f8f2">filter_implementations</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">detect</span> <span style="color: #f8f8f2">{</span> <span style="color: #f92672">|</span><span style="color: #f8f8f2">each</span><span style="color: #f92672">|</span> <span style="color: #f8f8f2">each</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">can_filter?(object,</span> <span style="color: #f8f8f2">block)</span> <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">filter_implementations</span>
      <span style="color: #f92672">[</span><span style="color: #66d9ef">CollectionFilter</span><span style="color: #f92672">::</span><span style="color: #66d9ef">Open</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">CollectionFilter</span><span style="color: #f92672">::</span><span style="color: #66d9ef">Closed</span><span style="color: #f92672">]</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">can_filter?</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #f8f8f2">subclass_responsibility</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>

<span style="color: #75715e"># collection_filter/closed.rb</span>
<span style="color: #66d9ef">module</span> <span style="color: #f8f8f2">CollectionFilter</span>
  <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Closed</span> <span style="color: #f92672">&lt;</span> <span style="color: #66d9ef">Base</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">can_filter?</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #f92672">!</span><span style="color: #f8f8f2">block</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">call(object)</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">add</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">collection)</span>
      <span style="color: #75715e"># nothing to do</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>

<span style="color: #75715e"># collection_filter/open.rb</span>
<span style="color: #66d9ef">module</span> <span style="color: #f8f8f2">CollectionFilter</span>
  <span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Open</span> <span style="color: #f92672">&lt;</span> <span style="color: #66d9ef">Base</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">can_filter?</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">block)</span>
      <span style="color: #f8f8f2">block</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">call(object)</span>
    <span style="color: #66d9ef">end</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">add</span><span style="color: #f8f8f2">(object,</span> <span style="color: #f8f8f2">collection)</span>
      <span style="color: #f8f8f2">collection</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #f8f8f2">object</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>Look at the <code>detect</code> usage to find the filter, and the <code>if</code> was just gone. The collection triggered the decision, not
us. That&rsquo;s good.</p>

<p>How can we use it? Let&rsquo;s take a look at some simple tests, as well as the <code>Array</code> extension to build the filtered
collection easier:</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e"># undefined_collection_filter_test.rb</span>
<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">UndefinedCollectionFilterTest</span> <span style="color: #f92672">&lt;</span> <span style="color: #66d9ef">Minitest</span><span style="color: #f92672">::</span><span style="color: #66d9ef">Test</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">test_it_does_not_add_an_element_that_should_be_filtered</span>
    <span style="color: #f8f8f2">array</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">array_filtering_even_numbers</span>

    <span style="color: #f8f8f2">array</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #ae81ff">3</span>

    <span style="color: #f8f8f2">assert</span> <span style="color: #f8f8f2">array</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">empty?</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">test_it_adds_an_element_that_should_not_be_filtered</span>
    <span style="color: #f8f8f2">array</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">array_filtering_even_numbers</span>

    <span style="color: #f8f8f2">array</span> <span style="color: #f92672">&lt;&lt;</span> <span style="color: #ae81ff">12</span>

    <span style="color: #f8f8f2">assert</span> <span style="color: #f8f8f2">array</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">size</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">1</span>
    <span style="color: #f8f8f2">assert</span> <span style="color: #f8f8f2">array</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">include?(</span><span style="color: #ae81ff">12</span><span style="color: #f8f8f2">)</span>
  <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">array_filtering_even_numbers</span>
    <span style="color: #f8f8f2">condition</span> <span style="color: #f92672">=</span> <span style="color: #f92672">-&gt;</span><span style="color: #f8f8f2">(element)</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">element</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">even?</span> <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">Array</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">filter_with(condition)</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>

<span style="color: #75715e"># array.rb</span>
<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Array</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">self</span><span style="color: #f92672">.</span><span style="color: #a6e22e">filter_with</span><span style="color: #f8f8f2">(block)</span>
    <span style="color: #66d9ef">CollectionFilter</span><span style="color: #f92672">::</span><span style="color: #66d9ef">Undefined</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">filter_with(</span><span style="color: #66d9ef">new</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">block)</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>
</p>

<h2 id="wrapping-up">Wrapping up</h2>

<ul>
<li><p>This solution can be criticized because it has several classes, and it could be implemented in much less lines of
code. But, are the responsibilities in other potential smaller solutions well splitted? Are filters part of the
domain model of those solutions?</p></li>

<li><p>Which object do we need to touch for modifying the behavior when the filter does not let you pass? Well, one single
object with that specific responsibility.</p></li>

<li><p>It&rsquo;s good to evaluate an implementation not seeing only how easy it is, or how many lines of code it has, but also
validating all the responsibilities belong to the proper objects and how easy it is to be extended in the future.</p></li>

<li><p>To me, filters are relevant concepts, that is worth to have as separate objects. These relevant concepts (and
hidden most of the time) make a difference and they are a sign of mature, well modeled systems.</p></li>

<li><p>There&rsquo;s more coming! how we can use this filter with other kind of objects? is there more filtering options rather
than open/closed? these are some of the questions I&rsquo;ll try to answer in my next post.</p></li>

<li><p>You can take a look at the full code at the <a href="https://github.com/ngarbezza/collection_filter">collection_filter repo</a>.</p></li>
</ul>

  			</section>

  			<footer class="post-footer">
  				<div class="post-tags">
            
  				</div>
  				<div class="post-share">
  					<a class="icon-twitter" href="https://twitter.com/share?text=Collection%20Filters%20in%20Ruby&url=http%3a%2f%2fegutter.github.io%2fprueba-blog%2f2016%2f07%2f14%2fcollection-filters-in-ruby%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
  						<span>Twitter</span>
  					</a>
  					<a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fegutter.github.io%2fprueba-blog%2f2016%2f07%2f14%2fcollection-filters-in-ruby%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
  						<span>Facebook</span>
  					</a>
  					<a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2fegutter.github.io%2fprueba-blog%2f2016%2f07%2f14%2fcollection-filters-in-ruby%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
  						<span>Google+</span>
  					</a>
  				</div>
  			</footer>

  			<aside class="post-comments">
    
    
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
</aside>


			</div>

			<nav class="post-nav">
				
					<a class="post-nav-item post-nav-next" href="http://egutter.github.io/prueba-blog/2016/07/26/inverted-test-pyramid/">
						<section class="post-nav-teaser">
							<span class="post-nav-icon"><i class="icon-arrow-left"></i></span>
							<span class="post-nav-info">
								<h4 class="post-nav-title">An Inverted Test Pyramid</h4>
								<p class="post-nav-excerpt">&hellip;</p>
							</span>
						</section>
					</a>
				
				
					<a class="post-nav-item post-nav-prev" href="http://egutter.github.io/prueba-blog/2016/07/11/a-little-bit-of-color/">
						<section class="post-nav-teaser">
							<span class="post-nav-icon"><i class="icon-arrow-right"></i></span>
							<span class="post-nav-info">
								<h4 class="post-nav-title">A Little Bit of Color!</h4>
								<p class="post-nav-excerpt">&hellip;</p>
							</span>
						</section>
					</a>
				
				<div class="clear"></div>
			</nav>

		</div>
	</article>
</main>

				<div id="body-class" style="display: none;"></div>
				<footer id="footer">
					<section class="credits">
						<span class="credits-theme">Theme <a href="https://github.com/zenithar/hugo-theme-bleak" target="_blank" rel="nofollow">Bleak</a> by <a href="http://zutrinken.com" target="_blank" rel="nofollow">zutrinken</a></span>
						<span class="credits-software">Published with <a href="http://gohugo.io" target="_blank" rel="nofollow">Hugo</a></span>
					</section>
				</footer>
				
				
<div id="tocMenu" data-target="toc">
    <div class="menu-header">
        <span class="menu-label">Menu</span>
        <a class="menu-close" data-action="toc" data-target="toc"></a>
    </div>
    <div id="toc" class="menu-list">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#the-problem">The problem</a></li>
<li><a href="#first-approach">First approach</a></li>
<li><a href="#the-idea">The idea</a></li>
<li><a href="#implementing-collection-filters">Implementing collection filters</a></li>
<li><a href="#wrapping-up">Wrapping up</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>


				<div class="overlay"></div>
			</div>
		</section>

    <script>
      (function(c,f){asyncLoader=function(i,h){i.foreach(function(k,j){e(j,d(j),h)});if(typeof h.callback=="function"){var g=setInterval(function(){if(f.readyState==="complete"){clearInterval(g);h.callback()}},10)}};var d=function(g){var h=g.split(".");return h[h.length-1]},e=function(h,i,g){switch(i){case"js":a(h,g);break;case"css":b(h);break;default:break}},a=function(i,h){var g=document.createElement("script");g.type="text/javascript";g.async=true;g.src=i;document.getElementsByTagName("head")[0].appendChild(g)},b=function(g){var h=document.createElement("link");h.type="text/css";h.rel="stylesheet";h.href=g;document.getElementsByTagName("head")[0].appendChild(h)};Array.prototype.foreach=function(h){for(var g=0;g<this.length;g++){h(g,this[g])}}})(this,document);

      asyncLoader([
				"/js/dependencies.js",
				"/css/dependencies.css"
      ],{
        callback:function(){
					asyncLoader([
						"/css/style.css",
						"/js/script.js"
					], {
						callback: function() {
							$('body').fadeIn( 800 );
						}
					});
        }
      });

</script>



</body>
</html>

