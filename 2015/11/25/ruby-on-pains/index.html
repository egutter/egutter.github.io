<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Ruby On Pains</title>
  <link href="https://egutter.github.io/prueba-blog/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://egutter.github.io/prueba-blog/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://egutter.github.io/prueba-blog/images/default.png);}
  
  </style>
</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://egutter.github.io/prueba-blog"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">10 Pines Blog</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
        
        
        
          <a href="https://www.facebook.com/10Pines"><img src="https://egutter.github.io/prueba-blog/images/facebook-dreamstale25.png"></a>
        
        
        
        
          <a href="https://www.linkedin.com/in/10Pines"><img src="https://egutter.github.io/prueba-blog/images/linkedin-dreamstale45.png"></a>
        
          <a href="https://egutter.github.io/prueba-blog/index.xml"><img src="https://egutter.github.io/prueba-blog/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://egutter.github.io/prueba-blog//images/10pines-background.jpg">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>Ruby On Pains</h4>
          <p>
          
            
              <a href="https://egutter.github.io/prueba-blog/categories/ruby/">ruby</a>
            
              <a href="https://egutter.github.io/prueba-blog/categories/rails/">rails</a>
            
              <a href="https://egutter.github.io/prueba-blog/categories/best-practices/">best practices</a>
            
           
          </p>
          <p>

<p>Have you ever heard about the <em>Rails way</em>?
I would like to introduce some pains that I&rsquo;ve seen and keep seeing in all the Rails projects due to the <em>Rails way</em>&hellip;</p>

<h2 id="activerecord">ActiveRecord</h2>

<p>How many times do we need to find an object in a Rails project? How many times do we create, update or delete objects from the DB? Many times, isn&rsquo;t it? We are used to repeat these actions in all our ActiveRecord classes. We do it like monkeys, never ask for a timeout and think about it. It seems to be something <em>normal</em> when we use this framework, it&rsquo;s the famous <em>Rails way</em>. It&rsquo;s <em>normal</em> for us to have a class that answers <code>find</code>, <code>update</code>, <code>save</code>, etc, but we never think if itâ€™s right and whether there could be a better way of doing it.</p>

<p>It&rsquo;s typical to find this kind of logic in a Rails project, see the example of this controller:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">UserController</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">index</span>
    <span style="color: #f8f8f2">@users</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">User</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">all</span>
  <span style="color: #66d9ef">end</span>
  
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">show</span>
    <span style="color: #f8f8f2">@user</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">User</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find(params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:id</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
  <span style="color: #66d9ef">end</span>
    
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">create</span>
    <span style="color: #f8f8f2">@user</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">User</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">create(user_params)</span>
  <span style="color: #f92672">...</span>
  <span style="color: #66d9ef">private</span>
 
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">user_params</span>
    <span style="color: #f8f8f2">params</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">require(</span><span style="color: #e6db74">:user</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">permit(</span><span style="color: #f92672">...</span><span style="color: #f8f8f2">)</span>
  <span style="color: #66d9ef">end</span>
  <span style="color: #f92672">...</span>
</pre></div>


<p>The OO paradigm defines, among other things, that a class has two main responsibilities. The first one is defining the behavior for the objects of that class, and the second one is creating instances of it. This means that all objects that are instances of the same class can perform the same actions. So, when did we talk about persisting? We didn&rsquo;t say anything about classes having the responsibility of writing to the database or executing a query in order to load some instances in memory. Have you ever thought what are we doing to our classes in order to answer those kind of messages? Basically inheriting from <code>ActiveRecord::Base</code>, which is a strong association that defines a rigid behavior that doesn&rsquo;t follow the paradigm principles. Look at this alternative:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">UserController</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">index</span>
    <span style="color: #f8f8f2">@users</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">UserRecords</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find_all</span>
  <span style="color: #66d9ef">end</span>
  
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">show</span>
    <span style="color: #f8f8f2">@user</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">UserRecords</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find(params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:id</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
  <span style="color: #66d9ef">end</span>
  <span style="color: #f92672">...</span>
</pre></div>


<p>Definitely our business domain models shouldn&rsquo;t be coupled to the way we persist them. The main reason is both belong to different domains, having different kind of responsibilities. Moreover, have you ever thought about changing Rails for another framework? Our models shouldn&rsquo;t change, our code shouldn&rsquo;t change much. We should only need to change those entities in charge of persistence. But if those entities are the same that model our business domain, probably we are in trouble.</p>

<h2 id="validations">Validations</h2>

<p>Have you ever thought about invalid objects? Moreover, have you ever thought if it make sense to think about valid objects? Well, in real life we don&rsquo;t have invalid entities, we don&rsquo;t have invalid persons, or invalid cars, it would be ridiculous. But, since the external world interacts with computer systems, for example someone using a web application, we can always do it in a bad way. We can fill forms incorrectly, e.g. filling a telephone input field with my name. However this doesn&rsquo;t mean that invalid objects should exist. We can have validations or rules that need to be satisfied in order to process that form and create a new user in our system.</p>

<p>Let me be more specific. In a Rails project we can probably find controllers like&hellip;</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">def</span> <span style="color: #a6e22e">create</span>
  <span style="color: #f8f8f2">@user</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">User</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">create(params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:user</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
  <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">@user</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">valid?</span>
    <span style="color: #f8f8f2">redirect_to</span> <span style="color: #f8f8f2">show_path(@user)</span>
  <span style="color: #66d9ef">else</span>
    <span style="color: #f8f8f2">render</span> <span style="color: #e6db74">:create</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">errors</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">@user</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">errors</span>
  <span style="color: #66d9ef">end</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>We usually ask an object if it&rsquo;s valid because, I suppose, it&rsquo;s the <em>Rails way</em>. As I said, it&rsquo;s ridiculous, I&rsquo;m sure that User class is full of <code>validates</code> and we still can create invalid instances.</p>

<p>Suppose we are in 1930, and you go to a club asking for a sign up. The help desk gives you the users record book and asks you to write your enrollment, then the help desk checks whether you have filled the enrollment correctly. If you did it wrong, you will be asked to fix it. Well, I&rsquo;m sure that book would be full of corrections. Wouldn&rsquo;t it be better to have a sign up form that the helpdesk uses to complete an enrollment that we know is correct?</p>

<p>The problem here is that we are modeling a user when we don&rsquo;t have to. We are omitting something in the middle, the form. We aren&rsquo;t modeling that, take a look at this short example:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">def</span> <span style="color: #a6e22e">create</span>
  <span style="color: #f8f8f2">form</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">UserEnrollmentForm</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new(user_params)</span>
  <span style="color: #f8f8f2">@user</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">UserEnroller</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">call(form)</span>
  <span style="color: #f8f8f2">redirect_to</span> <span style="color: #f8f8f2">show_path(@user)</span>
<span style="color: #66d9ef">rescue</span> <span style="color: #66d9ef">UserEnrollmentError</span> <span style="color: #f92672">=&gt;</span> <span style="color: #f8f8f2">e</span>
  <span style="color: #f8f8f2">render</span> <span style="color: #e6db74">:create</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">form</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">form,</span> <span style="color: #e6db74">error</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">e</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>Here we are just delegating the responsibility of deciding whether to create or not a User based on an input form. Again, have in mind the given implementation is not part of the scope, we can discuss multiple ways of doing this. The main thing is, we should never have invalid objects in our system. If something goes wrong while creating or modifying an instance, I would like to be notified asap - In Rails, use the bang always!</p>

<h2 id="ruby-coals">Ruby Coals</h2>

<p>I like using that word just to refer to awful gems. What happens when you grab a coal? Your hands get dirty right? Well, this is what I feel with some gems when I start using them in a project. Also a coal is the primitive of a gem and it really feels like we are not progressing when we use that kind. The fact is that the <em>Rails way</em> is awesome cause we can find some functionality that someone has already built, installing that gem, and voilÃ¡.</p>

<p>Let&rsquo;s see some examples. We can start with this pagination coal&hellip;</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Post</span>
  <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">per_page</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">10</span>
<span style="color: #66d9ef">end</span>

<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">PostsController</span>
  <span style="color: #f92672">...</span>
  <span style="color: #f8f8f2">@posts</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">Post</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">paginate(</span><span style="color: #e6db74">page</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:page</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f92672">...</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>I don&rsquo;t like that way of doing things, we are breaking the OO design rule about responsibilities and not coupling things that belong to different domains. Here, we are coupling our <code>Post</code> model with the idea of paginating them for a view, that&rsquo;s crazy! We should find a better way, such as modeling a paginator instead of having our classes answering messages like <code>per_page</code> or <code>paginate</code>:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">PostsController</span>
  <span style="color: #f92672">...</span>
  <span style="color: #f8f8f2">paginator</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">Paginator</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new(</span><span style="color: #66d9ef">PostsBook</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find_all,</span> <span style="color: #e6db74">per_page</span><span style="color: #f8f8f2">:</span> <span style="color: #66d9ef">POSTS_PER_PAGE</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">posts</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">paginator</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">call(</span><span style="color: #e6db74">page</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:page</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f92672">...</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>Now take a look at this filtering coal&hellip;</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">Student</span>
  <span style="color: #f8f8f2">scope</span> <span style="color: #e6db74">:with_country_id</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">-&gt;</span> <span style="color: #f8f8f2">(country_id)</span> <span style="color: #f8f8f2">{</span> <span style="color: #960050; background-color: #1e0010">â€¦</span> <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">scope</span> <span style="color: #e6db74">:sorted_by</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">-&gt;</span> <span style="color: #f8f8f2">(field)</span> <span style="color: #f8f8f2">{</span> <span style="color: #f92672">...</span> <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">scope</span> <span style="color: #e6db74">:search_query</span><span style="color: #f8f8f2">,</span> <span style="color: #f92672">...</span>
      
  <span style="color: #f8f8f2">filterrific(</span>
    <span style="color: #e6db74">default_filter_params</span><span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">{</span> <span style="color: #e6db74">sorted_by</span><span style="color: #f8f8f2">:</span> <span style="color: #e6db74">&#39;created_at_desc&#39;</span> <span style="color: #f8f8f2">},</span>
    <span style="color: #e6db74">available_filters</span><span style="color: #f8f8f2">:</span> <span style="color: #f92672">[</span><span style="color: #e6db74">:sorted_by</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">:search_query</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">:with_country_id</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f92672">...</span>
<span style="color: #66d9ef">end</span>

<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">StudentController</span>
  <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">index</span>
    <span style="color: #f8f8f2">@filterrific</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">initialize_filterrific(</span><span style="color: #66d9ef">Student</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:filterrific</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">or</span> <span style="color: #66d9ef">return</span>
    <span style="color: #f8f8f2">@students</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">@filterrific</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">page(params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:page</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">respond_to</span> <span style="color: #66d9ef">do</span> <span style="color: #f92672">|</span><span style="color: #f8f8f2">format</span><span style="color: #f92672">|</span>
      <span style="color: #f8f8f2">format</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">html</span>
      <span style="color: #f8f8f2">format</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">js</span>
    <span style="color: #66d9ef">end</span>
  <span style="color: #66d9ef">end</span>
  <span style="color: #f92672">...</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>That&rsquo;s really good! Our models become a storage of filtering configuration! Seriously, the filtering functionallity that we offer in a view has nothing to do in our <code>Student</code> model. Does a student need to know about filtering configuration? One more time, we are coupling. Here is another simple way of doing this:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">class</span> <span style="color: #a6e22e">StudentController</span>
  <span style="color: #f92672">...</span>
    <span style="color: #f8f8f2">students_filter</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">StudentsFilter</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">new(params</span><span style="color: #f92672">[</span><span style="color: #e6db74">:filtering</span><span style="color: #f92672">]</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">@students</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">StudentRecords</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">with_filter(filter)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">find_all</span>
  <span style="color: #f92672">...</span>
<span style="color: #66d9ef">end</span>
</pre></div>


<p>Again, let me remeber that the examples shown above are just ilustrative, we are not discussing the implementation, but the approach we are choosing. My suggestion is, let&rsquo;s think twice before adding this kind of coals as your code will get dirty and removing or refactoring this kind of functionality to another place will be a pain in the ass.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In my opinion, Rails is a good framework for a kick-off. Itâ€™s easy to write the firsts test cases, implement the idea, and deploy it. But, what happens when the application starts to grow? Sometimes we lose our mind trying to get things out faster, and we shouldn&rsquo;t forget the importance of designing good models, otherwise implementing the next feature becomes a headache. Also you will always find multiple gems to solve your problem, but think the way you are going to implement such thing, most of them make your models dirty. Always remember that it is key to understand the essence of the objects in the reality&rsquo;s domain to keep it on our code.</p>
</p>
          <p>25 Nov 2015
            
          </p>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2016/01/04/there-are-null-reasons/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2015/11/02/learning-programming/"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/materialize.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

