<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>State and Polymorphism with Clojure</title>
  <link href="https://egutter.github.io/prueba-blog/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://egutter.github.io/prueba-blog/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://egutter.github.io/prueba-blog/images/default.png);}
  
  </style>
</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://egutter.github.io/prueba-blog"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">10 Pines Blog</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
        
        
        
          <a href="https://www.facebook.com/10Pines"><img src="https://egutter.github.io/prueba-blog/images/facebook-dreamstale25.png"></a>
        
        
        
        
          <a href="https://www.linkedin.com/in/10Pines"><img src="https://egutter.github.io/prueba-blog/images/linkedin-dreamstale45.png"></a>
        
          <a href="https://egutter.github.io/prueba-blog/index.xml"><img src="https://egutter.github.io/prueba-blog/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://egutter.github.io/prueba-blog//images/10pines-background.jpg">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>State and Polymorphism with Clojure</h4>
          <p>
          
            
              <a href="https://egutter.github.io/prueba-blog/categories/clojure/">clojure</a>
            
           
          </p>
          <p>

<p>A couple of weeks ago, I started to take my first steps on Clojure as part of my apprenticeship residency. Having very little experience with functional programming, I quickly run into a few situations that I wasn&rsquo;t sure how to handle. Setting aside Clojure&rsquo;s syntax, which even though I like its simplicity and consistency, I still find the number of parenthesis somewhat uncomfortable. This short post will be about a couple of differences with OOP that caught my attention: how to approach state and how to handle polymorphism.</p>

<h2 id="quick-note-on-state">Quick note on state</h2>

<p>I started by doing some simple exercises and examples, that mostly consisted of mathematical functions or processes with a very clear input and output - so far, so good. But when I moved to slightly more complex problems that involved some kind of change over time, I was tempted to imitate imperative programming and use some kind of variable. In fact, Clojure offers a number features that allow this: <a href="http://clojure.org/Vars">Vars</a>, <a href="http://clojure.org/Refs">Refs</a>, <a href="http://clojure.org/Agents">Agents</a> and <a href="http://clojure.org/Atoms">Atoms</a>.
For example, one of the exercises, which I had already implemented in Ruby, was modeling a tennis scoreboard. With OOP, I had an object that represented the game, and when someone scored I  could just send a message to that object and it would change the players&rsquo; score.</p>

<pre><code class="language-ruby">
game.score_a_point_for(a_player)

</code></pre>

<p>At first, I tried doing something like this by storing each player&rsquo;s score in an Atom, but by doing this, most of my functions would have side effects, therefore violating their [referential transparency](<a href="http://en.wikipedia.org/wiki/Referential_transparency_(computer_science)">http://en.wikipedia.org/wiki/Referential_transparency_(computer_science)</a>).
I ended up with a simpler solution by having a structure that represented the state of the game which was passed as a parameter to most functions, and most of them returned a new structure with the new state as a result. I think this solution looks simpler and more aligned with the functional paradigm.</p>

<pre><code class="language-clojure">
(score-point-for a-player game)

</code></pre>

<h2 id="polymorphism-with-multimethods">Polymorphism with multimethods</h2>

<p>Continuing with the same example, this function that calculates the new score could easily be solved with a series of <code>IF</code>s that concentrate all the game logic. I started by doing this but I wondered if I could use some kind of polymorphism instead, like I did with Ruby. In Ruby I modeled each of the scores (0, 15, 30, 40, A) as a set of polymorphic objects that know the next result after a player scores, thus distributing this logic. For example the Thirty points score looks like this:</p>

<pre><code class="language-ruby">
class ThirtyScore &lt; Score
  def initialize(player, game)
    @player = player
    @game = game
  end
  def point_scored
    @game.new_score_for(@player, FortyScore.new(@player, @game))
  end
end

</code></pre>

<p>While doing TDD, I started with the simplest cases and then arrived to the <strong>deuce</strong> case which is a bit more complex. To solve the next score I realized I also needed the opponent&rsquo;s score, so I refactored the points scored method like this<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>:</p>

<pre><code class="language-ruby">
class FortyScore &lt; Score
  def point_scored_on(opponent_score)
    opponent_score.resolve_new_score(self)
  end
  def resolve_new_score(opponent_score)
    opponent_score.advantage
  end
  def advantage
    @game.new_score_for(@player, AdvantageScore.new(@player, @game))
  end
end

</code></pre>

<p>Eventually I found that something similar could accomplished using <a href="http://clojure.org/multimethods">multimethods</a>. This Clojure  feature allows multiple implementations of a single function, but what method to execute does not depend on the object receiving the message but on a user defined <strong>dispatch function</strong>  instead:</p>

<pre><code class="language-clojure">
(defmulti calculate-next-score-for (fn [player game] (game player)))

(defmethod calculate-next-score-for :zero [player game]
(assoc game player :fifteen))

(defmethod calculate-next-score-for :fifteen [player game]
(assoc game player :thirty))

(defmethod calculate-next-score-for :thirty [player game]
(assoc game player :forty))

(defmethod calculate-next-score-for :forty [player game]
(resolv-possible-victory-for player game))

(defmethod calculate-next-score-for :advantage [player game]
(assoc game :winner player))

</code></pre>

<p><code>defmulti</code> defines a new multimethod with the dispatch function provided, in this case the function simply returns the player&rsquo;s current score, and based on this result it executes the proper method. By doing this we can avoid hard coding everything inside a big <code>IF</code>, and the resulting code makes it easier to differentiate each case, making it more declarative<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Maybe a more experienced Clojure developer would have done things differently, however this exercise was very interesting for me, as it allowed me to explore different solutions and how some things in functional programming can be done similarly to OOP. After this short time exploring the language, I still feel a little foreign to the functional paradigm but it served as a way to learn several useful concepts, including immutability and referential transparency.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">The complete solution for the tennis scoreboard in Ruby can be found <a href="https://github.com/nodarsan/TDD-TennisScoreRUBY">here</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">The complete solution for the tennis scoreboard in Clojure can be found <a href="https://github.com/nodarsan/clj-tennis/">here</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>
</p>
          <p>24 Sep 2014
            
          </p>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2014/09/24/symbols-the-new-return-codes/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2014/09/23/software-existentialism/"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/materialize.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

