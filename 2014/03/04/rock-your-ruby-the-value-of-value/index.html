<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Rock Your Ruby: The Value of Value</title>
  <link href="https://egutter.github.io/prueba-blog/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://egutter.github.io/prueba-blog/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://egutter.github.io/prueba-blog/images/default.png);}
  
  </style>
</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://egutter.github.io/prueba-blog"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://egutter.github.io/prueba-blog/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">10 Pines Blog</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
        
        
        
          <a href="https://www.facebook.com/10Pines"><img src="https://egutter.github.io/prueba-blog/images/facebook-dreamstale25.png"></a>
        
        
        
        
          <a href="https://www.linkedin.com/in/10Pines"><img src="https://egutter.github.io/prueba-blog/images/linkedin-dreamstale45.png"></a>
        
          <a href="https://egutter.github.io/prueba-blog/index.xml"><img src="https://egutter.github.io/prueba-blog/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://egutter.github.io/prueba-blog//images/10pines-background.jpg">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>Rock Your Ruby: The Value of Value</h4>
          <p>
          
            
              <a href="https://egutter.github.io/prueba-blog/categories/ruby/">ruby</a>
            
           
          </p>
          <p>

<p>Check out the Ruby Gem at <a href="https://github.com/10Pines/value_protocol">GitHub</a></p>

<h2 id="introduction">Introduction</h2>

<p>Go ahead and ask the developer sitting next to you what is the thing that loves
the most about Ruby. It should come as no surprise that simplicity, flexibility
and expressiveness are the main reasons Ruby junkies just can&rsquo;t get enough of
it.</p>

<p>In Matz own words, seems like the &lsquo;go with the flow&rsquo; philosophy was present
right from the start in the Ruby community:</p>

<p>{% blockquote %}
&ldquo;Actually, I&rsquo;m trying to make Ruby natural, not simple.&rdquo;
{% endblockquote %}</p>

<h2 id="cuttin-loose-from-the-language-cliché">Cuttin&rsquo; loose from the language cliché</h2>

<p>I do believe in the principles and values Ruby was built upon, but I don&rsquo;t like
clichés. We should be critic about the restrictions a programming language
impose on us, and really pay attention when things don&rsquo;t feel right.</p>

<p>Here&rsquo;s a concrete example to show you what I&rsquo;m talking about. Check out these
uses of the <code>:detect</code> message:</p>

<pre><code class="language-ruby">
discount_rules.detect(lambda{ default_discount_rule }) { |rule| rule.applies_on? a_product }
students.detect(lambda{ anonymous_student }) { |student| student.is_named? 'John' }

</code></pre>

<p>Do they &lsquo;feel natural&rsquo; to you? Do you think there is something wrong with them?
Take another look.</p>

<h2 id="noise-duplication">Noise &amp; Duplication</h2>

<p>There are two things that fire my alarms about these examples.</p>

<p>First, the unnecessary noisy syntax<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup> needed to pass the block that gets
evaluated when no object matched the <code>:detect</code> condition<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup>. I feel that
departs from the original intent of Ruby (to feel natural to the developer) by
forcing the use of &lsquo;tech&rsquo; terms.</p>

<p>Second, the presence of repeated code. I don&rsquo;t mind writing blocks if I really
need to, but they seem overkill when all I want is to return an object to handle
the &ldquo;if none&rdquo; case.</p>

<h2 id="dealing-with-duplicated-code">Dealing with duplicated code</h2>

<p>In the Object Oriented paradigm repeated code is a symptom of a missing
abstraction, a concept that is not being modeled. As a consequence, what would
be its implementation is scattered around the methods that were supposed to use
it.</p>

<p>It should be clear from the examples that repeated code does not mean repeated
text, but repeated collaborations of message sends. These examples were choosen
to demonstrate that repeating code involves repeating collaborations of message
sends, instead of simply repeating text<sup class="footnote-ref" id="fnref:3"><a rel="footnote" href="#fn:3">3</a></sup>.</p>

<p>Let&rsquo;s take a look at what is repeated, and what is not, between the two uses of
<code>:detect</code>:</p>

<pre><code class="language-ruby">
discount_rules.detect(lambda{ default_discount_rule }) { |rule| rule.applies_on? a_product }
students.detect(lambda{ anonymous_student }) { |student| student.is_named? 'John' }

# the collaboration pattern seems to be:
FOO.detect(lambda{ BAR }) { BAZ }

</code></pre>

<p>Whenever we want to return an object when no object matches a condition we&rsquo;re
wrapping it with a <code>lambda</code>, because that is what the <code>:detect</code> message expects
as first collaborator.</p>

<p>One way to go would be to add a new method to the <code>Enumerable</code> module that does
the dirty lambda wrapping for us, but that solution would only work for
<code>:detect</code>.</p>

<p>It would be great to come up with a more generic solution, one that works for
any method that expects a block to be passed in.</p>

<h2 id="designing-a-generic-solution">Designing a generic solution</h2>

<p>We would like is to be able to express these examples in a more natural way,
getting rid of the extra <code>lambda</code> parts:</p>

<pre><code class="language-ruby">
# look ma' no lambdas!
discount_rules.detect(default_discount_rule) { |rule| rule.applies_on? a_product }
students.detect(anonymous_student) { |student| student.is_named? 'John' }

</code></pre>

<p>Let&rsquo;s start solving this &ldquo;challenge&rdquo; not only by writing a test first, but
writing the test&rsquo;s assert first:</p>

<pre><code class="language-ruby">
it 'should be possible to pass any object when a block without arguments is expected' do
  apple = Object.new
  fruits = []
    
  fruit = fruits.detect(apple) { |fruit| false }
  
  fruit.should == apple
end

</code></pre>

<p>After running it (and watching it turn red) the failure message reveales the
root of the problem:</p>

<pre><code>NoMethodError: undefined method `call' for #&lt;Object:0x00000001390d68&gt;
</code></pre>

<p>Besides the missing message implementation, what this really means is that
instances of <code>Object</code> are not polymorphic with lambdas (instances of <code>Proc</code>)
with respect to the <code>:call</code> message.</p>

<p>To make this tests pass, let&rsquo;s do the simplest thing possible and add the
<code>:call</code> method returning <code>self</code> to <code>Object</code>.</p>

<p>But hey, we can do better! What about being able to pass an arbitraty object to
the <code>:select</code> method (which expects an <em>implicit</em> block that takes one external
collaborator)?</p>

<pre><code class="language-ruby">
it 'should be possible to pass any object when an implicit block with arguments is expected' do
  apple = Object.new
  orange = Object.new
  fruits = [apple, orangee]
  apples_only = FruitFilter.new apple

  selected_fruits = fruits.select &amp;apples_only

  selected_fruits.should have(1).item
  selected_fruits.should include apple
end

</code></pre>

<p><em>FruitFilter<sup class="footnote-ref" id="fnref:4"><a rel="footnote" href="#fn:4">4</a></sup> is a test class I used to express better the intent of the
test.</em></p>

<p>This time, the failure message is a little more cryptic:</p>

<pre><code>TypeError: wrong argument type Object (expected Proc)
</code></pre>

<p>We need an instance of <code>Proc</code> to be passed in to <code>:select</code>. The unary <code>&amp;</code>
operator converts blocks to procs, but <code>Object</code> is not a <code>proc</code> and neither
knows how to respond to the <code>:to_proc</code> message that gets sent when using <code>&amp;</code>.</p>

<p>Let&rsquo;s do the simplest thing to pass the test, and implement <code>:to_proc</code> in
<code>Object</code>, returning a <code>proc</code> that evaluates <code>self.call</code> (that was implemented in
the first test).</p>

<p>Here&rsquo;s how <code>Object</code> looks like after passing the tests:</p>

<pre><code class="language-ruby">
class Object

  def call *args
    self
  end

  def to_proc
    proc{ |*args| self.call *args }
  end

end

</code></pre>

<p><em>There are still some test cases left to be consider to make sure everything
works as expected/nothing was broken (like backwards compatibility with <code>Proc</code>,
<code>Method</code> and <code>Symbol</code> <code>:call</code> and <code>:to_proc</code> methods)<sup class="footnote-ref" id="fnref:5"><a rel="footnote" href="#fn:5">5</a></sup>.</em></p>

<h2 id="what-s-the-deal-with-the-value-of-value">What&rsquo;s the deal with the &ldquo;Value of Value&rdquo;?</h2>

<p>The need to reduce the friction when working with blocks was motivated by the
way Smalltalk solves the problem. Any object knows how to respond to the
<code>#value</code> message (which behaves in the same as the <code>:call</code> message just
implemented).</p>

<p>Even though the implementation is pretty straight forward, just returning
<code>self</code>, relying on <code>#value</code> in Smalltalk allows us to express domain concepts
better, making the code easier to read by dealing with objects or blocks in the
same way<sup class="footnote-ref" id="fnref:6"><a rel="footnote" href="#fn:6">6</a></sup>.</p>

<p>From my point of view, it is a little method that adds great value.</p>

<h2 id="conclusion">Conclusion</h2>

<p>By working the solution step by step through TDD, we&rsquo;re now in a position to
explain and tell the cause of repeated code in the initial examples: instances
of <code>Object</code> were not polymorphic with instances of <code>Proc</code>. That forced us to
wrap objects in lambdas so <code>:detect</code> could work as expected.</p>

<p>Two missing abstractions (methods, in this case) were implemented in <code>Object</code> to
get rid of repeated code, <code>:call</code> and <code>:to_proc</code> methods.</p>

<p>Besides the immediate benefit of the implemented feature, I really enjoyed the
oportunity to strictly follow the OO paradigm and TDD to see how far they can be
taken. I valued the fact that Ruby can be modified to make it fit my needs.</p>

<p>Do not take for granted a language is expressive or feels natural just because
that&rsquo;s what the documentations says and the community accepts it without
questioning. Learn from the past (as we did from Smalltalk in this case) to
avoid reinventing the flat tire.</p>

<p>Don&rsquo;t get trapped in the language cliché. Build your own Ruby.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">I&rsquo;m talking about the <code>lambda</code>/<code>proc</code> keywords preceding the braces needed to create a <code>Proc</code>.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">see <code>:detect</code> method documentation at <a href="http://ruby-doc.org/core-2.1.0/Enumerable.html#method-i-detect">RubyDoc</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">If you want to understand or learn more about this concept, enroll in one of our courses! See <a href="http://www.10pines.com/training/listado-cursos/diseno-avanzado-de-software-con-objetos-i">Diseño Avanzado de Software Con Objetos I</a> and <a href="http://www.10pines.com/training/listado-cursos/diseno-avanzado-de-software-con-objetos-ii">Diseño Avanzado de Software Con Objetos II</a>
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
<li id="fn:4">FruitFilter <a href="https://github.com/10Pines/value_protocol/blob/master/spec/fruit_filter.rb">source code</a>
 <a class="footnote-return" href="#fnref:4"><sup>[return]</sup></a></li>
<li id="fn:5">Check the whole test suite at <a href="https://github.com/10Pines/value_protocol/tree/master/spec">GitHub</a>
 <a class="footnote-return" href="#fnref:5"><sup>[return]</sup></a></li>
<li id="fn:6">Dont&rsquo; just stand there! Go ahead, grab a copy of <a href="http://pharo.org/">Pharo</a> (a Smalltalk dialect) and browse for implementors and senders of <code>#value</code>
 <a class="footnote-return" href="#fnref:6"><sup>[return]</sup></a></li>
</ol>
</div>
</p>
          <p>4 Mar 2014
            
          </p>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2014/03/21/rethinking-estimations/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://egutter.github.io/prueba-blog/2014/02/01/refactoring-legacy-code-story/"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/materialize.min.js"></script>
  <script src="https://egutter.github.io/prueba-blog/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

